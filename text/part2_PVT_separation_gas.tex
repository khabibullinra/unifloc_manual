Функция \mintinline{vb.net}{feed_mod_separate_gas} описывает процесс сепарации свободного газа из потока, например на приёме УЭЦН или в газосепараторе.
После отделения части свободного газа из потока, свойства потока по прежнему могут быть описаны в рамках модели нелетучей нефти, но с несколько модифицированными параметрами, учитывающими изменение фазового состава. Функция \mintinline{vb.net}{feed_mod_separate_gas} как раз рассчитывает такие параметры.

Алгоритм модификации параметров потока сводится к снижению газового фактора и расхода свободного газа, что удаляет газ из потока. При необходимости проводится корректировка давления насыщения $P_b$, объёмного коэффициента при давлении насыщения $B_{ob}$ и вязкости при давлении насыщения $\mu_{ob}$. 

Как правило, сепарация газа из потока проводится при относительно низком давлении, например при давлении на приёме насоса. Для потока в трубах предполагается, что  в каждый момент времени все фазы потока находятся в термодинамическом равновесии, что позволяет применять корреляции для нелетучей нефти.  Однако при поступлении частично дегазированного потока в насос, давление в нем резко повышается на значительную величину (для центробежного насоса с производительностью 150 м$^3$/сут, время прохождения потоком через одну ступень составляет около 0.02 сек \cite{diss_Igrevesky_ESP_gas}, таким образом через ЭЦН с 400 ступеней поток будет двигаться порядка 10 сек. При этом давление может повыситься на величину порядка 200 атм). За такое время свободный газ оставшийся в потоке может не успеть достичь термодинамического равновесия с нефтью, или другими слова может не успеть полностью раствориться. В работе Игревского В.И. \cite{diss_Igrevesky_ESP_gas} для учёта этого эффекта вводится коэффициент фазной неравновесности $K_f$

$$K_f = \frac{V_{sol}}{V_{eq}}= \frac{Q_{g.sol}}{Q_{g.eq}}$$

где  $V_{sol}$ - объем газа который растворится в нефти при движении через ЭЦН, $V_{sol}$ - объем газа который растворился бы в нефти при движении через ЭЦН при достижении термодинамического равновесия. 

Величина $K_f$ зависит среди прочих параметров от дисперсности потока (размера пузырьков газа), и объёмного газосодержания.  Для грубодисперсных смесей газ - вода можно принять $K_f=0.2$, для тонкодисперсных от $K_f=0.7$ до $K_f=1$. Для газонефтяных смесей можно считать $K_f=1$, то есть весь газ успевает раствориться в нефти при движении через ЭЦН. Это же предположении может быть использовано при движении газонефтяной смеси через трубы (скорость движения меньше в 5 - 10 раз в НКТ по сравнению с ЭЦН).

Для оценки влияния фазной неравновесности нефти на параметры многофазного потока при сепарации газа из потока можно использовать параметр \mintinline{vb.net}{gas_goes_into_solution}, который определяет значение   $K_f$

При условии $K_f = 0$ -- газ выделившийся в свободное состояние не растворяется обратно в нефти, при $K_f = 1$ -- весь газ может раствориться при повышении давления.

Новый газовый фактор и расход свободного газа, после сепарации газа можно найти из условия
\begin{equation}
	r_p^{new} = r_p - \left( r_p - r_s \right) k_{sep} 
\end{equation}

\begin{equation}
q_{gas}^{new} = q_{gas}(1-k_{sep}) 
\end{equation}

Максимально возможное значение газосодержания при повышении давления можно найти из выражения

\begin{equation} 
	r_s^{max} = r_s + \left( r_p - r_s \right) (1 - k_{sep}) *K_f 
	\label{eq:rsmax}
\end{equation}

При повышении давления часть газа может раствориться в нефти, что можно описать найдя величины $P_{b}^{new}$, $B_{ob}^{new}$,$\mu_{ob}^{new}$ c учетом максимально достижимого значения газосодержания (\ref{eq:rsmax}).

$$P_{b}^{new} = P_b(r_s^{max}) $$

$$B_{ob}^{new} = B_{ob}(r_s^{max}) $$

$$\mu_{ob}^{new} = \mu_{ob}(r_s^{max}) $$

где соответствующие зависимости $P_{b}(r_s)$, $B_{o}(r_s)$,$\mu_{o}(r_s)$ определяются в соответствии с заданным набором корреляций.

Рассмотрим пример 1 преобразования свойств потока флюида для следующего набора параметров:
параметры сепарации:  $k_{sep} = 0.5$ ,$p_{sep} = 50$   атма,	$t_{sep} = 90$   C ,$K_f = 0 $.    


\begin{table}[ht]
	\centering
	\caption{Исходные данные и результаты расчёта модификации флюида после частичной сепарации свободного газа. Пример 1, $K_f=0$ -- газ не растворяется при повышении давления.}
	\begin{tabular}{ |c|c|c|} 
		\hline
		Параметр & Исходные значения & Модифицированные \\ 
		\hline
		$\gamma_g$ 				&$0.9$	& $0.9$    \\ 
		$\gamma_o$ 					&$0.9$	& $0.9$   \\ 
		$r_{sb}$ ,  м$^3$/м$^3$ 		&$80$	& $25$ \\ 
		$P_b$ , атма 					&$130$	& $50$ 	 \\ 
		$T_{res} $,  C 					&$90$	& $90$ \\ 
		$B_{ob} $ , м$^3$/м$^3$  		&$1.2$	& $1.09$ \\ 
		$\mu_{ob}  $,  сП  				&$1$	& $1.96$   \\ 
		\hline
		$Q_{gas\ free}  $,  м$^3$/сут  	&$1000$	& $500$  \\ 
		$Q_{liq}  $,  м$^3$/сут  			&$15$	& $15$ \\ 
		$f_{w}  $,  \%  					&$1$	& $1$  \\ 
		$r_p  $,  м$^3$/м$^3$  			&$80$	& $52$ \\ 
		\hline
	\end{tabular}
	\label{table:separ_gas_table_1}
\end{table}

Зависимости свойств флюида от давления для примера 1 приведены на рисунке \ref{ris:separ_gas_plot_1}.

\begin{figure}[ht]
\begin{tikzpicture}[scale=0.65]
	\begin{axis}[
		xlabel=$P \;  atma$,
		ylabel=$r_s\; m^3/m^3$,
		legend pos=north west,
		title=газосодержание]
		\addplot table [y=rs, x=P]{data/separ_gas.txt};
		\addlegendentry{original}
		\addplot table [y=rs_mod, x=P]{data/separ_gas.txt};
		\addlegendentry{modified}
	\end{axis}
\end{tikzpicture}
\begin{tikzpicture}[scale=0.65]
	\begin{axis}[
		xlabel=$P \;  atma$,
		ylabel=$B_o\; m^3/m^3$,
		legend pos=north west,
		title=объемный коэффициент нефти]
		\addplot table [y=bo, x=P]{data/separ_gas.txt};
		\addlegendentry{original}
		\addplot table [y=bo_mod, x=P]{data/separ_gas.txt};
		\addlegendentry{modified}
	\end{axis}
\end{tikzpicture}
\begin{tikzpicture}[scale=0.65]
	\begin{axis}[
		xlabel=$P \;  atma$,
		ylabel=$\mu_o\; cP$,
		legend pos=north east,
		title=вязкость нефти]
		\addplot table [y=muo, x=P]{data/separ_gas.txt};
		\addlegendentry{original}
		\addplot table [y=muo_mod, x=P]{data/separ_gas.txt};
		\addlegendentry{modified}
	\end{axis}
\end{tikzpicture}
\caption{Зависимость параметров флюида от давления до и после сепарации части свободного газа. Пример 1, $K_f=0$ -- газ не растворяется при повышении давления}
\label{ris:separ_gas_plot_1}
\end{figure}

Из приведённых рисунков видно, что свойства нефти при давлении ниже давления сепарации не изменились, а новое давление насыщения показывает, что при повышении давления газ не будет растворяться в нефти. При этом значения параметров потока жидкости $Q_{liq}, f_w$ не изменяются.

При увеличении коэффициента неравновесности $K_f=0.9$ картина изменится - эффективное значение давления насыщения нефти вырастет, что позволит части газа раствориться. Ниже приводится пример 2, где также для наглядности изменён набор корреляций для следующего набора параметров: $k_{sep} = 0.5$ ,$p_{sep} = 50$   атма,	$t_{sep} = 90$   C ,$K_f = 0.9 $. Результаты расчета приведены в таблице \ref{table:separ_gas_table_2} и на   рисунке \ref{ris:separ_gas_plot_2}.

Следует отметить, что на величину эффективного значения давления насыщения может значительно влиять выбор набора корреляций для расчёта PVT свойств, в частности корреляции для зависимости давления насыщения от газосодержания при давлении насыщения. 

\begin{table}[H]
	\centering
	\caption{Исходные данные и результаты расчёта модификации флюида после частичной сепарации свободного газа. Пример 2, $K_f=0.9$ -- газ частично растворяется при повышении давления.}
	\begin{tabular}{ |c|c|c|} 
		\hline
		Параметр & Исходные значения & Модифицированные \\ 
		\hline
		$\gamma_g$ 				&$0.9$	& $0.9$    \\ 
		$\gamma_o$ 					&$0.9$	& $0.9$   \\ 
		$r_{sb}$ ,  м$^3$/м$^3$ 		&$80$	& $61$ \\ 
		$P_b$ , атма 					&$130$	& $84$ 	 \\ 
		$T_{res} $,  C 					&$90$	& $90$ \\ 
		$B_{ob} $ , м$^3$/м$^3$  		&$1.2$	& $1.16$ \\ 
		$\mu_{ob}  $,  сП  				&$1$	& $1.22$   \\ 
		\hline
		$Q_{gas\ free}  $,  м$^3$/сут  	&$1000$	& $500$  \\ 
		$Q_{liq}  $,  м$^3$/сут  			&$15$	& $15$ \\ 
		$f_{w}  $,  \%  					&$1$	& $1$  \\ 
		$r_p  $,  м$^3$/м$^3$  			&$80$	& $63$ \\ 
		\hline
	\end{tabular}
\label{table:separ_gas_table_2}
\end{table}

Зависимости свойств флюида от давления для примера 2 приведены на рисунке \ref{ris:separ_gas_plot_2}.

\begin{figure}[H]
\begin{tikzpicture}[scale=0.65]
	\begin{axis}[
		xlabel=$P \;  atma$,
		ylabel=$r_s\; m^3/m^3$,
		legend pos=north west,
		title=газосодержание]
		\addplot table [y=rs, x=P]{data/separ_gas_1.txt};
		\addlegendentry{original}
		\addplot table [y=rs_mod, x=P]{data/separ_gas_1.txt};
		\addlegendentry{modified}
	\end{axis}
\end{tikzpicture}
\begin{tikzpicture}[scale=0.65]
	\begin{axis}[
		xlabel=$P \;  atma$,
		ylabel=$B_o\; m^3/m^3$,
		legend pos=north west,
		title=объемный коэффициент нефти]
		\addplot table [y=bo, x=P]{data/separ_gas_1.txt};
		\addlegendentry{original}
		\addplot table [y=bo_mod, x=P]{data/separ_gas_1.txt};
		\addlegendentry{modified}
	\end{axis}
\end{tikzpicture}
\begin{tikzpicture}[scale=0.65]
	\begin{axis}[
		xlabel=$P \;  atma$,
		ylabel=$\mu_o\; cP$,
		legend pos=north east,
		title=вязкость нефти]
		\addplot table [y=muo, x=P]{data/separ_gas_1.txt};
		\addlegendentry{original}
		\addplot table [y=muo_mod, x=P]{data/separ_gas_1.txt};
		\addlegendentry{modified}
	\end{axis}
\end{tikzpicture}
\caption{Зависимость параметров флюида от давления до и после сепарации части свободного газа. Пример 2, $K_f=0.9$ -- газ частично растворяется при повышении давления}
\label{ris:separ_gas_plot_2}
\end{figure}


Часть настроек управляющая выводом результатов задается в виде закодированной строки в аргументе \mintinline{vb.net}{param}.

\begin{table}[H]
	\caption{Параметры функции \mintinline{vb.net}{feed_mod_separate_gas} передаваемые через аргумент -- \mintinline{vb.net}{param}}
	\label{table:param_list_feed_med_separation}
	\begin{tabular}{p{0.4\textwidth}p{0.55\textwidth}}
		\hline
		Ключ & Описание  \\ \hline
		\mintinline{vb.net}{show_array} & Показывать расширенные результаты расчета: 0 -- результат в виде одного числа (значение по умолчанию), 1 -- результат в виде массива.    \\ \hline
		
		\mintinline{vb.net}{show_log} & Показывать лог расчета в выводе. 0 -- лог выводиться не будет, 1 -- будет показан лог в виде json строки в массиве вывода. Большой размер лога может вызвать проблемы на некоторых версиях Excel.   \\ \hline
		
		\mintinline{vb.net}{gas_goes_into_solution} & Коэффициент фазной неравновесности $K_f$  \\ \hline
		
	\end{tabular}
\end{table}

При включенной опции \mintinline{vb.net}{show_array=1} результат выдается в виде двумерного массива значений - плоской таблицы. Результирующая таблица может быть непосредственно выведена в ячейки Excel (в версиях не поддерживающие динамические массивы необходимо использовать Cntrl-Shift-Enter для вывода результата в заранее выделенный диапазон ячеек) или получена в виде массива при вызове из VBA.

При выводе массива на лист Excel первая строка содержит значения параметров, вторая подписи к значениям. При выводе с использованием Cntrl-Shift-Enter можно вывести только первую строку параметров и распространить расчетную формулу протягиванием на несколько строк.

\begin{table}[H]
	\caption{Расширенный вывод функции \mintinline{vb.net}{feed_mod_separate_gas}}
	\label{table:param_list}
	\begin{tabular}{p{0.05\textwidth}p{0.3\textwidth}p{0.545\textwidth}}
		\hline
		№& Параметр & Описание  \\ \hline
		0 & \mintinline{vb.net}{feed} & json строка описывающая параметры модифицированного потока флюидов    \\ \hline
		
		1 & \mintinline{vb.net}{log} & Лог расчета, выводится при \mintinline{vb.net}{show_log = 1}  \\ \hline
		
	\end{tabular}
\end{table}
